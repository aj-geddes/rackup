generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PLAYER
  CAPTAIN
  LEAGUE_OFFICIAL
  ADMIN
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  POSTPONED
  CANCELLED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  phone         String?  @unique
  passwordHash  String
  firstName     String
  lastName      String
  avatar        String?
  role          Role     @default(PLAYER)
  handicap      Int      @default(3)
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  phoneVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  teamId        String?
  team          Team?    @relation(fields: [teamId], references: [id])

  captainOf     Team?    @relation("TeamCaptain")
  coCaptainOf   Team?    @relation("TeamCoCaptain")

  playerStats   PlayerStats[]
  matchResults  MatchResult[]

  createdAnnouncements Announcement[] @relation("AnnouncementCreator")
  createdInvites       Invite[]       @relation("InviteCreator")

  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]     @relation("AuditUser")

  @@index([email])
  @@index([phone])
  @@index([teamId])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Invite {
  id          String       @id @default(uuid())
  phone       String
  token       String       @unique
  firstName   String?
  lastName    String?
  teamId      String?
  role        Role         @default(PLAYER)
  status      InviteStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  createdById String
  createdBy   User         @relation("InviteCreator", fields: [createdById], references: [id])

  @@index([phone])
  @@index([token])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Team {
  id           String   @id @default(uuid())
  name         String   @unique
  logo         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  seasonId     String
  season       Season   @relation(fields: [seasonId], references: [id])

  captainId    String?  @unique
  captain      User?    @relation("TeamCaptain", fields: [captainId], references: [id])

  coCaptainId  String?  @unique
  coCaptain    User?    @relation("TeamCoCaptain", fields: [coCaptainId], references: [id])

  members      User[]
  homeMatches  Match[]  @relation("HomeTeam")
  awayMatches  Match[]  @relation("AwayTeam")
  standings    Standing?

  @@index([seasonId])
}

model Season {
  id          String   @id @default(uuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(false)
  playoffDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teams       Team[]
  matches     Match[]
  standings   Standing[]
  playerStats PlayerStats[]

  @@index([isActive])
}

model Venue {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  matches   Match[]
}

model Match {
  id         String      @id @default(uuid())
  date       DateTime
  time       String
  status     MatchStatus @default(SCHEDULED)
  week       Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  seasonId   String
  season     Season      @relation(fields: [seasonId], references: [id])

  homeTeamId String
  homeTeam   Team        @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId String
  awayTeam   Team        @relation("AwayTeam", fields: [awayTeamId], references: [id])

  venueId    String?
  venue      Venue?      @relation(fields: [venueId], references: [id])

  homeScore  Int?
  awayScore  Int?

  results    MatchResult[]

  @@index([seasonId])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([date])
  @@index([status])
}

model MatchResult {
  id           String   @id @default(uuid())
  matchId      String
  match        Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  playerId     String
  player       User     @relation(fields: [playerId], references: [id])

  gameNumber   Int
  won          Boolean
  isRunout     Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@unique([matchId, playerId, gameNumber])
  @@index([playerId])
}

model Standing {
  id        String   @id @default(uuid())
  wins      Int      @default(0)
  losses    Int      @default(0)
  rank      Int?
  streak    String   @default("0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teamId    String   @unique
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  seasonId  String
  season    Season   @relation(fields: [seasonId], references: [id])

  @@index([seasonId])
  @@index([rank])
}

model PlayerStats {
  id        String   @id @default(uuid())
  wins      Int      @default(0)
  losses    Int      @default(0)
  runouts   Int      @default(0)
  rank      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  playerId  String
  player    User     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  seasonId  String
  season    Season   @relation(fields: [seasonId], references: [id])

  @@unique([playerId, seasonId])
  @@index([seasonId])
  @@index([rank])
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  isUrgent  Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creatorId String
  creator   User     @relation("AnnouncementCreator", fields: [creatorId], references: [id])

  @@index([isActive])
  @@index([createdAt])
}

model Backup {
  id          String   @id @default(uuid())
  filename    String
  size        Int
  type        String   // 'local' or 'google_drive'
  driveFileId String?
  createdAt   DateTime @default(now())
  createdBy   String

  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  userId    String?
  user      User?    @relation("AuditUser", fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([action])
}

model GoogleDriveConfig {
  id           String   @id @default(uuid())
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?
  folderId     String?
  isConfigured Boolean  @default(false)
  updatedAt    DateTime @updatedAt
}

model SmsConfig {
  id           String   @id @default(uuid())
  provider     String   @default("twilio") // twilio, vonage, etc.
  accountSid   String?
  authToken    String?
  fromNumber   String?
  isConfigured Boolean  @default(false)
  updatedAt    DateTime @updatedAt
}
